
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Nistats: Functional MRI in Python &#8212; functional MRI for NeuroImaging</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1b',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="search" title="Search" href="../../search.html" />
<meta content="True" name="HandheldFriendly">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="keywords" content="nistats, neuroimaging, python, neuroscience, statistics">
<script type="text/javascript">
$(function () {
    // Lock the table of content to a fixed position once we scroll enough
    var top = 105 + $('.sphinxsidebarwrapper').offset().top - parseFloat($('.sphinxsidebarwrapper').css('margin-top').replace(/auto/, 0)),
        sections = {},
        i        = 0,
	url	 = document.URL.replace(/#.*$/, ""),
	current_section = 0;

    // Grab positions of our sections
    $('.headerlink').each(function(){
        sections[this.href.replace(url, '')] = $(this).offset().top - 50;
    });

    $(window).scroll(function(event) {
	var pos   = $(window).scrollTop();
	// Lock the table of content to a fixed position once we scroll enough
	if(pos > top){
	    //begin to scroll
	    $('.sphinxsidebarwrapper').css("position", "fixed");
	    $('.sphinxsidebarwrapper').css("top", -105);
	}
	else{
	    //lock it back into place
	    $('.sphinxsidebarwrapper').css("position", "relative");
	    $('.sphinxsidebarwrapper').css("top",0);
	}

	// Highlight the current section
	$('a.internal').removeClass('active');
        for(i in sections){
            if(sections[i] > pos){
		break;
            };
	    if($('a.internal[href$="' + i + '"]').is(':visible')){
		current_section = i;
	    };
        }
	$('a.internal[href$="' + current_section + '"]').addClass('active');
    });

});
</script>


<script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-41920728-1']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

  </head>
  <body>
<div id="logo-banner">
  <div class="logo">
    <a href="../../index.html">
      <img src="../../_static/nistats-logo.png" alt="Nistats logo"  border="0" />
    </a>
  </div>
  <!-- A tag cloud to make it easy for people to find what they are
                         looking for -->
 <div class="tags">
  <ul>
    <li>
      <big><a href="../04_low_level_functions/plot_hrf.html">HRF</a></big>
    </li>
    <li>
      <small><a href="../04_low_level_functions/plot_design_matrix.html">Design Matrix</a></small>
    </li>
    <li>
      <small><a href="../02_first_level_models/plot_localizer_analysis.html">First Level</a></small>
    </li>
    <li>
      <big><a href="../03_second_level_models/plot_thresholding.html">Second Level</a></big>
    </li>
    <li>
      <big><a href="plot_bids_analysis.html">BIDS datasets</a></big>
    </li>
  </ul>
 </div>

  <div class="banner">
    <h1>Nistats:</h1>
    <h2>Functional MRI Neuro-Imaging in Python</h2>
  </div>
  <div class="search_form">
    <div id="cse" style="width: 100%;"></div>
    <script src="http://www.google.com/jsapi" type="text/javascript"></script>
    <script type="text/javascript">
      google.load('search', '1', {language : 'en'});
      google.setOnLoadCallback(function() {
      var customSearchControl = new google.search.CustomSearchControl('014136483057745874622:r-npolb1uki');
      customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
      var options = new google.search.DrawOptions();
      options.setAutoComplete(true);
      customSearchControl.draw('cse', options);
      }, true);
    </script>
  </div>
</div>



    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a></li>
<li><a href="../../index.html">Nistats Home</a> |&nbsp;</li>
<li><a href="../../user_guide.html">User Guide</a> |&nbsp;</li>
<li><a href="../index.html">Examples</a> |&nbsp;</li>
<li><a href="../../modules/reference.html">Reference</a> |&nbsp;</li>
<li id="navbar-about"><a href="../../authors.html">About</a>|&nbsp;</li>
<li id="navbar-ecosystem"><a href="http://www.nipy.org/">Nipy ecosystem</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">


<h4> Giving credit </h4>
  <ul class="simple">
    <li><p>Please consider <a href="../../authors.html#citing">citing the
                    papers</a>.</p></li>
  </ul>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Studying first-level-model details in a trials-and-error fashion</a><ul>
<li><a class="reference internal" href="#retrieving-the-data">Retrieving the data</a></li>
<li><a class="reference internal" href="#running-a-basic-model">Running a basic model</a></li>
<li><a class="reference internal" href="#changing-the-drift-model">Changing the drift model</a></li>
<li><a class="reference internal" href="#changing-the-hemodynamic-response-model">Changing the hemodynamic response model</a></li>
<li><a class="reference internal" href="#the-noise-model-ar-1-or-ols">The noise model ar(1) or ols ?</a></li>
<li><a class="reference internal" href="#removing-confounds">Removing confounds</a></li>
<li><a class="reference internal" href="#smoothing">Smoothing</a></li>
<li><a class="reference internal" href="#masking">Masking</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>


<div class="navbar">
</div> <!-- end navbar -->

<script type="text/javascript">$('#searchbox-ml').show(0);</script>
<script type="text/javascript">$('#searchbox-site').show(0);</script>


        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="studying-first-level-model-details-in-a-trials-and-error-fashion">
<span id="sphx-glr-auto-examples-01-tutorials-plot-first-level-model-details-flymake-py"></span><h1>Studying first-level-model details in a trials-and-error fashion<a class="headerlink" href="#studying-first-level-model-details-in-a-trials-and-error-fashion" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we study the parametrization of the first-level
model used for fMRI data analysis and clarify their impact on the
results of the analysis.</p>
<p>We use an exploratory approach, in which we incrementally include some
new features in the analysis and look at the outcome, i.e. the
resulting brain maps.</p>
<p>Readers without prior experience in fMRI data analysis should first
run the <span class="xref std std-ref">plot_single_subject_single_run</span> tutorial to get a bit more
familiar with the base concepts, and only then run this tutorial example.</p>
<p>To run this example, you must launch IPython via <code class="docutils literal"><span class="pre">ipython</span>
<span class="pre">--matplotlib</span></code> in a terminal, or use <code class="docutils literal"><span class="pre">jupyter-notebook</span></code>.</p>
<div class="contents local topic" id="contents">
<p class="topic-title first"><strong>Contents</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#retrieving-the-data" id="id1">Retrieving the data</a></li>
<li><a class="reference internal" href="#running-a-basic-model" id="id2">Running a basic model</a></li>
<li><a class="reference internal" href="#changing-the-drift-model" id="id3">Changing the drift model</a></li>
<li><a class="reference internal" href="#changing-the-hemodynamic-response-model" id="id4">Changing the hemodynamic response model</a></li>
<li><a class="reference internal" href="#the-noise-model-ar-1-or-ols" id="id5">The noise model ar(1) or ols ?</a></li>
<li><a class="reference internal" href="#removing-confounds" id="id6">Removing confounds</a></li>
<li><a class="reference internal" href="#smoothing" id="id7">Smoothing</a></li>
<li><a class="reference internal" href="#masking" id="id8">Masking</a></li>
<li><a class="reference internal" href="#conclusion" id="id9">Conclusion</a></li>
</ul>
</div>
<div class="section" id="retrieving-the-data">
<h2><a class="toc-backref" href="#id1">Retrieving the data</a><a class="headerlink" href="#retrieving-the-data" title="Permalink to this headline">¶</a></h2>
<p>We use a so-called localizer dataset, which consists in a 5-minutes
acquisition of a fast event-related dataset.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nistats</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">fetch_localizer_first_level</span><span class="p">()</span>
<span class="n">fmri_img</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">epi_img</span>
</pre></div>
</div>
<p>Define the paradigm that will be used We just need to get the provided file.</p>
<p>This task, described in Pinel et al., BMC neuroscience 2007 probes
basic functions, such as button with the left or right hand, viewing
horizontal and vertical checkerboards, reading and listening to
short sentences, and mental computations (subractions).</p>
<blockquote>
<div>Visual stimuli were displayed in four 250-ms epochs, separated by
100ms intervals (i.e., 1.3s in total). Auditory stimuli were drawn
from a recorded male voice (i.e., a total of 1.6s for motor
instructions, 1.2-1.7s for sentences, and 1.2-1.3s for
subtraction). The auditory or visual stimuli were shown to the
participants for passive viewing or button response in
event-related paradigms.  Post-scan questions verified that the
experimental tasks were understood and followed correctly.</div></blockquote>
<p>This task comprises 10 conditions:</p>
<ul class="simple">
<li>clicGaudio: Left-hand three-times button press, indicated by visual instruction</li>
<li>clicDaudio: Right-hand three-times button press, indicated by visual instruction</li>
<li>clicGvideo: Left-hand three-times button press, indicated by auditory instruction</li>
<li>clicDvideo:  Right-hand three-times button press, indicated by auditory instruction</li>
<li>damier_H: Visualization of flashing horizontal checkerboards</li>
<li>damier_V: Visualization of flashing vertical checkerboards</li>
<li>phraseaudio: Listen to narrative sentences</li>
<li>phrasevideo: Read narrative sentences</li>
<li>calculaudio: Mental subtraction, indicated by auditory instruction</li>
<li>calculvideo: Mental subtraction, indicated by visual instruction</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">t_r</span> <span class="o">=</span> <span class="mf">2.4</span>
<span class="n">paradigm_file</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">paradigm</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">events</span><span class="o">=</span> <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.read_table.html#pandas.read_table" title="View documentation for pandas.read_table"><span class="n">pd</span><span class="o">.</span><span class="n">read_table</span></a><span class="p">(</span><span class="n">paradigm_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="running-a-basic-model">
<h2><a class="toc-backref" href="#id2">Running a basic model</a><a class="headerlink" href="#running-a-basic-model" title="Permalink to this headline">¶</a></h2>
<p>First specify a linear model.
the fit() model creates the design matrix and the beta maps.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nistats.first_level_model</span> <span class="kn">import</span> <span class="n">FirstLevelModel</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Let us take a look at the design matrix: it has 10 main columns corresponding to 10 experimental conditions, followed by 3 columns describing low-frequency signals (drifts) and a constant regressor.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nistats.reporting</span> <span class="kn">import</span> <span class="n">plot_design_matrix</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_001.png" class="align-center" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_001.png" />
<p>Specification of the contrasts.</p>
<p>For this, let’s create a function that, given the design matrix,
generates the corresponding contrasts.  This will be useful to
repeat contrast specification when we change the design matrix.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">make_localizer_contrasts</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns a dictionary of four contrasts, given the design matrix&quot;&quot;&quot;</span>

    <span class="c1"># first generate canonical contrasts</span>
    <span class="n">contrast_matrix</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.11.0/reference/generated/numpy.eye.html#numpy.eye" title="View documentation for numpy.eye"><span class="n">np</span><span class="o">.</span><span class="n">eye</span></a><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">contrasts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">column</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>

    <span class="c1"># Add more complex contrasts</span>
    <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicDaudio&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicGaudio&#39;</span><span class="p">]</span> <span class="o">+</span>\
                         <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;calculaudio&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;phraseaudio&#39;</span><span class="p">]</span>
    <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicDvideo&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicGvideo&#39;</span><span class="p">]</span> <span class="o">+</span> \
                         <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;calculvideo&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;phrasevideo&#39;</span><span class="p">]</span>
    <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;computation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;calculaudio&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;calculvideo&#39;</span><span class="p">]</span>
    <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;phraseaudio&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;phrasevideo&#39;</span><span class="p">]</span>

    <span class="c1"># Short dictionary of more relevant contrasts</span>
    <span class="n">contrasts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;left-right&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicGaudio&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicGvideo&#39;</span><span class="p">]</span>
                       <span class="o">-</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicDaudio&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;clicDvideo&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;H-V&#39;</span><span class="p">:</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;damier_H&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;damier_V&#39;</span><span class="p">],</span>
        <span class="s1">&#39;audio-video&#39;</span><span class="p">:</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;video&#39;</span><span class="p">],</span>
        <span class="s1">&#39;computation-sentences&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;computation&#39;</span><span class="p">]</span> <span class="o">-</span>
                                  <span class="n">contrasts</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">]),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">contrasts</span>
</pre></div>
</div>
<p>So let’s look at these computed contrasts</p>
<ul class="simple">
<li>“left - right button press” probes motor activity in left versus right button presses</li>
</ul>
<p>‘H-V’: probes the differential activity in viewing a horizontal vs vertical checkerboard
* “audio - video” probes the difference of activity between listening to some content or reading the same type of content (instructions, stories)
* “computation - sentences” looks at the activity when performing a mental comptation task  versus simply reading sentences.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">contrasts</span> <span class="o">=</span> <span class="n">make_localizer_contrasts</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.figure.AxesStack.html#matplotlib.figure" title="View documentation for matplotlib.pyplot.figure"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">nistats.reporting</span> <span class="kn">import</span> <span class="n">plot_contrast_matrix</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">ax</span> <span class="o">=</span> <a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplot.html#matplotlib.pyplot.subplot" title="View documentation for matplotlib.pyplot.subplot"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span></a><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_contrast_matrix</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">=</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_002.png" class="align-center" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_002.png" />
<p>Contrast estimation and plotting</p>
<p>Since this script will be repeated several times, for the sake of readability,
we encapsulate it in a function that we call when needed.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>

<span class="k">def</span> <span class="nf">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given a first model, specify, enstimate and plot the main contrasts&quot;&quot;&quot;</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Call the contrast specification within the function</span>
    <span class="n">contrasts</span> <span class="o">=</span> <span class="n">make_localizer_contrasts</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <a href="http://matplotlib.org/api/_as_gen/matplotlib.figure.AxesStack.html#matplotlib.figure" title="View documentation for matplotlib.pyplot.figure"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># compute the per-contrast z-map</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ax</span> <span class="o">=</span> <a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplot.html#matplotlib.pyplot.subplot" title="View documentation for matplotlib.pyplot.subplot"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrasts</span><span class="p">),</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">z_map</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">compute_contrast</span><span class="p">(</span>
            <span class="n">contrast_val</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;z_score&#39;</span><span class="p">)</span>
        <a href="http://nilearn.github.io/modules/generated/nilearn.plotting.plot_stat_map.html#nilearn.plotting.plot_stat_map" title="View documentation for nilearn.plotting.plot_stat_map"><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span></a><span class="p">(</span>
            <span class="n">z_map</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">cut_coords</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s run the model and look at the outcome.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_003.png" class="align-center" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_003.png" />
</div>
<div class="section" id="changing-the-drift-model">
<h2><a class="toc-backref" href="#id3">Changing the drift model</a><a class="headerlink" href="#changing-the-drift-model" title="Permalink to this headline">¶</a></h2>
<p>By default the drift model is a set of slow oscillating functions (Discrete Cosine transform), with a cutoff at frequency 1/128 hz.
We can change this cut-off, e.g. to 1/64Hz.
This is done by setting period_cut=64(s)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">period_cut</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_004.png" class="align-center" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_004.png" />
<p>Does the model perform worse or better ?</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_005.png" class="align-center" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_005.png" />
<p>Note that the design matrix has more columns to model drifts in the data.</p>
<p>We notice however that this model performs rather poorly.</p>
<p>Another solution is to remove these drift terms. Maybe they’re simply useless.
this is done by setting drift_model to None.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">drift_model</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_006.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_006.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_006.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_007.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_007.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_007.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>Is it better than the original ? No !</p>
<p>Note that the design matrix has changed with no drift columns.
the event columns, on the other hand, haven’t changed.
Another alternative to get a drift model is to specify a set of polynomials
Let’s take a basis of 5 polynomials</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">drift_model</span><span class="o">=</span><span class="s1">&#39;polynomial&#39;</span><span class="p">,</span> <span class="n">drift_order</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_008.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_008.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_008.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_009.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_009.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_009.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>Is it good ? No better, no worse. Let’s turn to another parameter.</p>
</div>
<div class="section" id="changing-the-hemodynamic-response-model">
<h2><a class="toc-backref" href="#id4">Changing the hemodynamic response model</a><a class="headerlink" href="#changing-the-hemodynamic-response-model" title="Permalink to this headline">¶</a></h2>
<p>This is the filter used to convert the event sequence into a reference BOLD signal for the design matrix.</p>
<p>The first thing that we can do is to change the default model (the so-called Glover hrf) for the so-called canonical model of SPM –which has slightly weaker undershoot component.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm&#39;</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_010.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_010.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_010.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_011.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_011.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_011.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>No strong –positive or negative– effect.</p>
<p>We could try to go one step further: using not only the so-called canonical hrf, but also its time derivative. Note that in that case, we still perform the contrasts  and obtain statistical significance for the main effect —not the time derivative. This means that the inclusion of time derivative in the design matrix has the sole effect of discounting timing misspecification from the error term, which vould decrease the estimated variance and enhance the statistical significance of the effect. Is it the case ?</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative&#39;</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_012.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_012.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_012.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_013.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_013.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_013.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>Not a huge effect, but rather positive overall. We could keep that one.</p>
<p>Bzw, a benefit of this approach is that we can test which voxels are well explined by the derivative term, hinting at misfit regions, a possibly valuable information
This is implemented by an F test on the time derivative regressors.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">contrast_val</span> <span class="o">=</span> <a href="http://docs.scipy.org/doc/numpy-1.11.0/reference/generated/numpy.eye.html#numpy.eye" title="View documentation for numpy.eye"><span class="n">np</span><span class="o">.</span><span class="n">eye</span></a><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span>
<span class="n">z_map</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">compute_contrast</span><span class="p">(</span>
    <span class="n">contrast_val</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;z_score&#39;</span><span class="p">)</span>
<a href="http://nilearn.github.io/modules/generated/nilearn.plotting.plot_stat_map.html#nilearn.plotting.plot_stat_map" title="View documentation for nilearn.plotting.plot_stat_map"><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span></a><span class="p">(</span>
    <span class="n">z_map</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;effect of time derivatives&#39;</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_014.png" class="align-center" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_014.png" />
<p>We don’t see too much here: the onset times and hrf delay we’re using are probably fine.</p>
<p>We can also consider adding the so-called dispersion derivative to capture some mis-specification in the shape of the hrf.
this is done by specifying <cite>hrf_model=’spm + derivative + dispersion’</cite></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative + dispersion&#39;</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_015.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_015.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_015.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_016.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_016.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_016.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>Not a huge effect. For the sake of simplicity and readibility, we can drop that one.</p>
</div>
<div class="section" id="the-noise-model-ar-1-or-ols">
<h2><a class="toc-backref" href="#id5">The noise model ar(1) or ols ?</a><a class="headerlink" href="#the-noise-model-ar-1-or-ols" title="Permalink to this headline">¶</a></h2>
<p>So far,we have implicitly used a lag-1 autoregressive model —aka ar(1)— for the temporal structure of the noise. An alternative choice is to use an ordinaly least squares model (ols) that assumes no temporal structure (time-independent noise)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative&#39;</span><span class="p">,</span> <span class="n">noise_model</span><span class="o">=</span><span class="s1">&#39;ols&#39;</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_017.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_017.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_017.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_018.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_018.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_018.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>While the difference is not obvious you should rather stick to the ar(1) model, which is arguably more accurate.</p>
</div>
<div class="section" id="removing-confounds">
<h2><a class="toc-backref" href="#id6">Removing confounds</a><a class="headerlink" href="#removing-confounds" title="Permalink to this headline">¶</a></h2>
<p>A problematic feature of fMRI is the presence of unconctrolled confounds in the data, sue to scanner instabilities (spikes) or physiological phenomena, such as motion, heart and respiration-related blood oxygenation flucturations.
Side measurements are sometimes acquired to charcterise these effects. Here we don’t have access to those.
What we can do instead is to estimate confounding effects from the data themselves, using the compcorr approach, and take those into account in the model.</p>
<p>For this we rely on the so-called  <span class="xref std std-ref">high_variance_confounds</span> routine of Nilearn.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.image</span> <span class="kn">import</span> <a href="http://nilearn.github.io/modules/generated/nilearn.image.high_variance_confounds.html#nilearn.image.high_variance_confounds" title="View documentation for nilearn.image.high_variance_confounds"><span class="n">high_variance_confounds</span></a>
<span class="n">confounds</span> <span class="o">=</span> <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.var.html#pandas.DataFrame" title="View documentation for pandas.DataFrame"><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span></a><span class="p">(</span><a href="http://nilearn.github.io/modules/generated/nilearn.image.high_variance_confounds.html#nilearn.image.high_variance_confounds" title="View documentation for nilearn.image.high_variance_confounds"><span class="n">high_variance_confounds</span></a><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative&#39;</span><span class="p">)</span>
<span class="n">first_level_model</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span>
                                          <span class="n">confounds</span><span class="o">=</span><span class="n">confounds</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_019.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_019.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_019.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_020.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_020.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_020.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>Note the five additional columns in the design matrix</p>
<p>The effect on activation maps is complex: auditory/visual effects are killed, probably because they were somewhat colinear to the confounds. On the other hand, some of the maps become cleaner (H-V, computation) after this addition.</p>
</div>
<div class="section" id="smoothing">
<h2><a class="toc-backref" href="#id7">Smoothing</a><a class="headerlink" href="#smoothing" title="Permalink to this headline">¶</a></h2>
<p>Smoothing is a regularization of the model. It has two benefits: decrease the noise level in images, and reduce the discrepancy between individuals. The drawback is that it biases the shape and position of activation.
We simply illustrate here the statistical gains.
We use a mild smoothing of 5mm full-width at half maximum (fwhm).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span>
    <span class="n">t_r</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative&#39;</span><span class="p">,</span> <span class="n">smoothing_fwhm</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span> <span class="n">confounds</span><span class="o">=</span><span class="n">confounds</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_021.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_021.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_021.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_022.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_022.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_022.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
<p>The design is unchanged but the maps are smoother and more contrasted</p>
</div>
<div class="section" id="masking">
<h2><a class="toc-backref" href="#id8">Masking</a><a class="headerlink" href="#masking" title="Permalink to this headline">¶</a></h2>
<p>Masking consists in selecting the region of the image on which the model is run: it is useless to run it outside of the brain.
the approach taken by FirstLeveModel is to estimate it from the fMRI data themselves when no mask is explicitly provided.
Since the data have been resampled into MNI space, we can use instead a mask  of the grey matter in MNI space. The benefit is that it makes voxel-level comparisons easier across subjects and datasets, and removed non-grey matter regions, in which no BOLD signal is expected.
The downside is that the mask may not fit very well these particular data.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <a href="http://nilearn.github.io/modules/generated/nilearn.plotting.plot_roi.html#nilearn.plotting.plot_roi" title="View documentation for nilearn.plotting.plot_roi"><span class="n">plot_roi</span></a>
<span class="kn">from</span> <span class="nn">nilearn.datasets</span> <span class="kn">import</span> <a href="http://nilearn.github.io/modules/generated/nilearn.datasets.fetch_icbm152_brain_gm_mask.html#nilearn.datasets.fetch_icbm152_brain_gm_mask" title="View documentation for nilearn.datasets.fetch_icbm152_brain_gm_mask"><span class="n">fetch_icbm152_brain_gm_mask</span></a>
<span class="n">icbm_mask</span> <span class="o">=</span> <a href="http://nilearn.github.io/modules/generated/nilearn.datasets.fetch_icbm152_brain_gm_mask.html#nilearn.datasets.fetch_icbm152_brain_gm_mask" title="View documentation for nilearn.datasets.fetch_icbm152_brain_gm_mask"><span class="n">fetch_icbm152_brain_gm_mask</span></a><span class="p">()</span>
<span class="n">data_mask</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">masker_</span><span class="o">.</span><span class="n">mask_img_</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.figure.AxesStack.html#matplotlib.figure" title="View documentation for matplotlib.pyplot.figure"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span></a><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplot.html#matplotlib.pyplot.subplot" title="View documentation for matplotlib.pyplot.subplot"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span></a><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<a href="http://nilearn.github.io/modules/generated/nilearn.plotting.plot_roi.html#nilearn.plotting.plot_roi" title="View documentation for nilearn.plotting.plot_roi"><span class="n">plot_roi</span></a><span class="p">(</span><span class="n">icbm_mask</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ICBM mask&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplot.html#matplotlib.pyplot.subplot" title="View documentation for matplotlib.pyplot.subplot"><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span></a><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<a href="http://nilearn.github.io/modules/generated/nilearn.plotting.plot_roi.html#nilearn.plotting.plot_roi" title="View documentation for nilearn.plotting.plot_roi"><span class="n">plot_roi</span></a><span class="p">(</span><span class="n">data_mask</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Data-driven mask&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_023.png" class="align-center" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_023.png" />
<p>Impact on the first-level model</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">first_level_model</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span>
    <span class="n">t_r</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative&#39;</span><span class="p">,</span> <span class="n">smoothing_fwhm</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">fmri_img</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span> <span class="n">confounds</span><span class="o">=</span><span class="n">confounds</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">first_level_model</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
<span class="n">plot_contrast</span><span class="p">(</span><span class="n">first_level_model</span><span class="p">)</span>
<a href="http://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_024.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_024.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_024.png" style="width: 300.79999999999995px; height: 225.6px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../../_images/sphx_glr_plot_first_level_model_details_flymake_025.png"><img alt="../../_images/sphx_glr_plot_first_level_model_details_flymake_025.png" src="../../_images/sphx_glr_plot_first_level_model_details_flymake_025.png" style="width: 517.0px; height: 141.0px;" /></a>
</li>
</ul>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id9">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>Interestingly, the model used here seems quite resilient to manipulation of modeling parameters: this is reassuring. It shows that Nistats defaults (‘cosine’ drift, cutoff=128s, ‘glover’ hrf, ar(1) model) are actually reasonable.
Note that these conclusions are specific to this dataset and may vary with other ones.</p>
<p><strong>Total running time of the script:</strong> ( 1 minutes  28.608 seconds)</p>
<div class="sphx-glr-footer docutils container">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../../_downloads/plot_first_level_model_details_flymake.py" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_first_level_model_details_flymake.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../../_downloads/plot_first_level_model_details_flymake.ipynb" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_first_level_model_details_flymake.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Generated by Sphinx-Gallery</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a></li>
<li><a href="../../index.html">Nistats Home</a> |&nbsp;</li>
<li><a href="../../user_guide.html">User Guide</a> |&nbsp;</li>
<li><a href="../index.html">Examples</a> |&nbsp;</li>
<li><a href="../../modules/reference.html">Reference</a> |&nbsp;</li>
<li id="navbar-about"><a href="../../authors.html">About</a>|&nbsp;</li>
<li id="navbar-ecosystem"><a href="http://www.nipy.org/">Nipy ecosystem</a></li>
 
      </ul>
    </div>
    <div class="footer">
            &copy; The nistats developers 2010-2016.
          Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.7.
        <span style="padding-left: 5ex;">
          <a href="../../_sources/auto_examples/01_tutorials/plot_first_level_model_details_flymake.rst.txt"
        	 rel="nofollow">Show this page source</a>
        </span>
    </div>
  </body>
</html>